function [Brg,Bzg,Athetag]=loop_B(a,d,r,z)% Written by R. H. Goulding, 10/1/98% Calculates the magnetic field components generated by a filamentary current% loop. It is assumed that the loop is in a plane perpendicular to the z axis% and is centered on the z axis. All units taken to be MKS (Amperes, meters,% Tesla). Uses the Matlab function ellipke to calculate the complete elliptic% integrals of the first and second kind K and E.% Input parameters: % %  a   radius of current loop %  d   axial distance of loop from z=0 point ( can be >0 or <0 ) %  I   current in loop  %  r   radius at which B components are calculated %  z   axial location at which B components are calculated% Output parameters:% Br   radial B component% Bz   axial B component% Atheta  azimuthal vector potentialcnst=1.e-7;   % mu0/(4*pi)u2=4*r.*a./((r+a).^2+(z-d).^2);  % argument of elliptical integral functionsu=sqrt(u2);[K,E]=ellipke(u2);Brg=-2*cnst./r.^(1.5).*(z-d)./sqrt(a).*(u/2.*K-u/4.*(u2-2)./(u2-1).*E);Bzg=2*cnst./r.*(sqrt(r./a).*u/2.*K-u./(4*(u2-1)).*(sqrt(r./a).*(u2-2)+sqrt(a./r).*u2).*E);Athetag=2*cnst./sqrt(r).*sqrt(a).*((2./u-u).*K-2./u.*E);