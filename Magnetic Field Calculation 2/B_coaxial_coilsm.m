%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%function [Brtot,Bztot,psi]=B_coaxial_coilsm(Br_g,Bz_g,At_g,avec,cur)                                   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Written by R. H. Goulding 12/16/98% This function is meant to be called after the function geom_coaxial_coils.m% which performs the geometry-dependent portion of the magnetic field calculation.% If only the coil currents are changed, it is only necessary to run this function% again, which executes extremely quickly.% This function calculates the magnetic induction (Br,Bz) due to an arbitrary% set of coaxial circular coils. It uses the exact solution for the magnetic% field produced by a circular filament and sums over filaments representing the% full coil set. This type of solution is not accurate in the immediate % neighborhood of (within a few mm for typical coil sizes) the coils, or % internal to the coils themselves, but is compact and executes quickly. In the% comments below nr is number of radial positions at which the fields are calculated% nz is the number of axial positions, and nc is the number of coils.%% Output variables:%%  Brtot  array of length (nr,nz) containing the magnitude of Br at locations %         specified by the vectors avec and zvec%%  Bztot  array of length (nr,nz) containing the magnitude of Bz at locations %         specified by the vectors avec and zvec%%  psi    array of length (nr,nz) containing the magnitude of the axial magnetic flux%%% Input variables:%%  Br_g  3-D array of length (nc,nr,nz) containing results of the geometry dependent%        portion of the Br magnetic field calculation. Calculated by geom_coaxial_coils.m.%  Bz_g  similar to Br_g, but containing Bz results%  At_g  similar to Br_g and Bz_g, but containing vector potential (Atheta) results.%  avec  vector of radial locations at which fields are calculated. Avec is returned%        by the geom_coaxial_coils.m function and is used to calculate psi.%  nz    scalar containing the number of axial positions at which to calculate%        the field quantities. It should be the same value as input to%        geom_coaxial_coils.m%  cur   vector of length nc containing currents for each coil.%%  NOTE: The variables as described above result in a model using 1 circular%        filament per individual coil turn. This usually gives accurate results.%        If it is desired to use additional filaments per turn, this can be done by%        increasing nturns and nlayers, and decreasing cur as appropriate to %        maintain a constant current density    nc=length(cur);   % number of coilssvec=size(Br_g);nz=svec(2);       % length of z position vectornr=round(svec(1)/nc);Brtot=zeros(nr,svec(2));Bztot=Brtot;Atheta=Brtot;for ic=1:nc; Brtot=Brtot+Br_g((ic-1)*nr+1:ic*nr,:)*cur(ic); Bztot=Bztot+Bz_g((ic-1)*nr+1:ic*nr,:)*cur(ic); Atheta=Atheta+At_g((ic-1)*nr+1:ic*nr,:)*cur(ic);end[dum,ra]=meshgrid(ones(nz,1),avec); % array of radii corresponding to Atheta arraypsi=Atheta.*ra; % axial magnetic flux = r*Atheta% Done